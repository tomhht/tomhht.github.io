<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://tomhht.github.io</id>
    <title>hello, world</title>
    <updated>2020-09-03T12:05:52.280Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://tomhht.github.io"/>
    <link rel="self" href="https://tomhht.github.io/atom.xml"/>
    <logo>https://tomhht.github.io/images/avatar.png</logo>
    <icon>https://tomhht.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, hello, world</rights>
    <entry>
        <title type="html"><![CDATA[k8s集群跨节点pods无法ping通以及无法curl]]></title>
        <id>https://tomhht.github.io/post/k8s-ji-qun-kua-jie-dian-pods-wu-fa-ping-tong/</id>
        <link href="https://tomhht.github.io/post/k8s-ji-qun-kua-jie-dian-pods-wu-fa-ping-tong/">
        </link>
        <updated>2020-09-03T10:33:25.000Z</updated>
        <summary type="html"><![CDATA[<p>除了k8s要求的端口要开，worker node上面flannel的端口<code>8285/udp（udp backend) 或8472/udp（vxlan backend）</code>也得开。</p>
]]></summary>
        <content type="html"><![CDATA[<p>除了k8s要求的端口要开，worker node上面flannel的端口<code>8285/udp（udp backend) 或8472/udp（vxlan backend）</code>也得开。</p>
<!-- more -->
<p>用<code>nmcli</code>查看，发现flannel 用到的是<code>vxlan backend</code>，因此需要打开<code>8472/udp</code>。<br>
打开后，发现Ubuntu的node可以被ping通，同时如果上面跑着<code>httpd</code>，其他node也可以<code>curl</code>到内容；而CentOS只能被ping通，<code>curl 10.244.2.19</code>的时候会显示<code>curl: (7) Failed to connect to 10.244.2.19 port 80: No route to host</code>。<br>
查了n多资料，几乎都是关闭防火墙，关闭后确实能解决，但我想这不是生产环境中的做法。最终在这位仁兄Louis He的博文<a href="https://www.cnblogs.com/Dev0ps/p/11401530.html">Kubernetes集群开启Firewall</a>中找到答案<code>add-masquerade</code>。同时也谢谢让我找到8472端口的仁兄<a href="https://www.codenong.com/39293441/">关于网络：Kubernetes集群所需的端口</a>。</p>
<pre><code># Ubuntu
sudo ufw allow 8472/udp #搞定

# CentOS
sudo firewall-cmd --zone=public --add-port=8472/udp --permanent
sudo firewall-cmd --reload #这步搞完只能被ping通，curl时是No route to host，头疼死了
sudo firewall-cmd --add-masquerade --permanent
sudo firewall-cmd --reload #这才把curl也打通了，我太难了
</code></pre>
<hr>
<p>参考链接：<br>
<a href="https://www.codenong.com/39293441/">https://www.codenong.com/39293441/</a><br>
<a href="https://www.cnblogs.com/Dev0ps/p/11401530.html">https://www.cnblogs.com/Dev0ps/p/11401530.html</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[圣莲山随笔]]></title>
        <id>https://tomhht.github.io/post/sheng-lian-shan-sui-bi/</id>
        <link href="https://tomhht.github.io/post/sheng-lian-shan-sui-bi/">
        </link>
        <updated>2020-09-03T06:39:26.000Z</updated>
        <summary type="html"><![CDATA[<p>上周六去了趟圣莲山，陪人散心，尽管好像只是把他当作车夫。</p>
]]></summary>
        <content type="html"><![CDATA[<p>上周六去了趟圣莲山，陪人散心，尽管好像只是把他当作车夫。</p>
<!-- more -->
<p>建议买观光车的票，否则从入口到正经爬山点有7里地，走个往返就该打道回府了。<br>
之前只是听人说过，这次别人想散心，于是推荐此地，想散心的当了全程司机。坐在车上往山里去是越来越凉快，途中也见到了十分陡峭的山，果然房山就是山多。<br>
散心人腿受伤了，因此到了景区后尽量搞不需要用腿的项目，比如观光车、缆车（内心OS：既然腿不好，来山上干啥）。<br>
其实本人是第一次坐缆车，稍微往下看看，确实有点腿软。同时想起意大利的一首民歌，就叫缆车，讲的是18几几年的事儿，有个老板搞山区旅游项目，于是搞了人力缆车，并且专门找作曲家写了个曲子，就是缆车，实际上原文的发音是fu ni ku li fu ni ku la，模拟缆车的声音，这个歌曲更准确说应该类似于咱们的劳动号子，大家边唱边使劲拉绳子。曲子非常欢快，进行曲的那种感觉，很多歌剧演员都唱过，比如著名的帕瓦罗蒂。但我第一次听是在芒果台的声入人心，一遍就喜欢上了。我妈觉得有些段落像是鬼子进村。<br>
缆车上山后，直奔观光车司机推荐的必去景点，一个叫圣莲宝塔，一个叫莲子峰。圣莲宝塔就是后人翻建的一个建筑，每层都绘制了佛教的故事。其实更喜欢纯的古建筑，或者以古修古的那种，可惜这个宝塔之前彻底倒塌了。塔旁边的山上还有题字，开始还以为是书法家才会题字，可这个字怎么看都觉得挺小学生的（没有侮辱小学生的意思），一直也联想不到是哪位大家的风格。正暗自感叹见识太少，忽听得旁人百度的结果，题字人正是宝塔翻建的出资人之一，心里的大石头终于落地，看来自己审美没出大问题。旁人也怀同样感觉，大家都释然了。当然出资人的功德肯定是大大的。<br>
实际上两个景点带来的感觉没有太震撼，但是游玩这种事情，过程才是核心。中间还路过一个景点叫八仙洞，就是在山上凿穿了个洞，看洞壁的坑坑洼洼，猜测应该是前人一凿一斧的心血，洞内凉气十足，且洞顶还有渗水滴下，我们感叹应该穿棉袄进来。后来散心人在洞外忽悠后来者，说洞里租军大衣。一个几岁的小男孩说什么也不进去，跟爸妈说里面可怕，我在想估计他们一家就要就此打住了，结果孩子爸妈想了个办法，把孩子抱上让孩子趴肩头挡住眼睛，直接就进去了。这都行，孩子就是孩子。<br>
之后我们找了个僻静处吃午饭，说实话背了一路，烧饼、香肠还有水，累死我了。我爸买的这香肠也有个性，外面塑料皮剥开，里面居然还有一层塑料膜，我还没叫出来，散心人已经一口啃下并吞下了一角塑料膜。这肠有个性，这人更有个性。</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[k8s操作笔记]]></title>
        <id>https://tomhht.github.io/post/k8s-cao-zuo-bi-ji/</id>
        <link href="https://tomhht.github.io/post/k8s-cao-zuo-bi-ji/">
        </link>
        <updated>2020-09-02T09:00:52.000Z</updated>
        <summary type="html"><![CDATA[<p>实操遇到问题好多，记录下。</p>
]]></summary>
        <content type="html"><![CDATA[<p>实操遇到问题好多，记录下。</p>
<!-- more -->
<h1 id="image拉取失败replicas被弃用">image拉取失败，replicas被弃用</h1>
<h2 id="问题">问题</h2>
<pre><code># 执行run，显示replicas has been deprecated，因此不生效，只部署了1个实例 
kubectl run httpd-app --image=httpd --replicas=2
# 检查pods运行情况，READY列显示未就绪
kubectl get pods -n wide
# 检查运行细节，一直显示pulling
kubectl describe pods httpd-app
</code></pre>
<h2 id="解决">解决</h2>
<ol>
<li>删除之前的部署：</li>
</ol>
<pre><code>kubectl delete pods httpd-app
</code></pre>
<ol start="2">
<li>创建部署文件：</li>
</ol>
<pre><code>cd ~/k8s
nano nginx.yaml
</code></pre>
<ol start="3">
<li>粘贴下面内容进nginx.yaml：</li>
</ol>
<pre><code># API 版本号
apiVersion: apps/v1
# 类型，如：Pod/ReplicationController/Deployment/Service/Ingress
kind: Deployment
metadata:
  # Kind 的名称
  name: nginx-app
spec:
  selector:
    matchLabels:
      # 容器标签的名字，发布 Service 时，selector 需要和这里对应
      app: nginx
  # 部署的实例数量
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      # 配置容器，数组类型，说明可以配置多个容器
      containers:
      # 容器名称
      - name: nginx
        # 容器镜像
        image: nginx:1.17
        # 只有镜像不存在时，才会进行镜像拉取
        imagePullPolicy: IfNotPresent
        ports:
        # Pod 端口
        - containerPort: 80
</code></pre>
<ol start="4">
<li>创建：</li>
</ol>
<pre><code>kubectl apply -f nginx.yaml
</code></pre>
<ol start="5">
<li>检查：</li>
</ol>
<pre><code>kubectl get deployments
kubectl describe deployment nginx-app
kubectl get replicaset
kubectl describe rs nginx-app-5d85b5fb59
kubectl get pods -o wide
kubectl describe pods nginx-app-5d85b5fb59-2ct5p
</code></pre>
<ol start="6">
<li>暴露服务：</li>
</ol>
<pre><code>kubectl expose deployment nginx-app --port=80 --type=LoadBalancer
</code></pre>
<ol start="7">
<li>查看服务状态(查看对外的端口)</li>
</ol>
<pre><code>kubectl get services
</code></pre>
<p><code>nginx-app</code>一直处于pending状态，应该是type设置为<code>LoadBalancer</code>，但没有云服务商和本地服务提供该功能。</p>
<hr>
<p>参考链接：<br>
<a href="https://blog.csdn.net/qq_43279371/article/details/107768713">https://blog.csdn.net/qq_43279371/article/details/107768713</a><br>
<a href="https://blog.csdn.net/kenkao/article/details/86764788">https://blog.csdn.net/kenkao/article/details/86764788</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[配置Ubuntu和CentOS清华源]]></title>
        <id>https://tomhht.github.io/post/pei-zhi-ubuntu-he-centos-qing-hua-yuan/</id>
        <link href="https://tomhht.github.io/post/pei-zhi-ubuntu-he-centos-qing-hua-yuan/">
        </link>
        <updated>2020-09-01T11:56:40.000Z</updated>
        <summary type="html"><![CDATA[<p>加快Ubuntu和CentOS软件下载速度。</p>
]]></summary>
        <content type="html"><![CDATA[<p>加快Ubuntu和CentOS软件下载速度。</p>
<!-- more -->
<h1 id="ubuntu">Ubuntu</h1>
<p>备份源配置文件：</p>
<pre><code>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
</code></pre>
<p>使用vim或gedit编辑source.list，用下面内容替换原有内容：</p>
<pre><code># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse

# 预发布软件源，不建议启用
# deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse
</code></pre>
<p>更新软件包缓存，使配置文件生效：</p>
<pre><code>sudo apt-get update
</code></pre>
<h1 id="centos">CentOS</h1>
<pre><code>path='/etc/yum.repos.d/'
repos=(CentOS-AppStream.repo CentOS-Base.repo CentOS-centosplus.repo CentOS-Extras.repo CentOS-PowerTools.repo)
for repo in ${repos[@]}; do
sudo cp $path$repo $path$repo'.bak' #备份源配置文件
sudo sed -i &quot;s/^mirrorlist/#&amp;/; s/^#baseurl/baseurl/; s/http:\/\/mirror.centos.org/https:\/\/mirrors.tuna.tsinghua.edu.cn\/centos/&quot; $path$repo #修改配置文件
done
# 更新软件包缓存，使配置文件生效
sudo yum makecache
</code></pre>
<hr>
<p>参考链接：<br>
<a href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a><br>
<a href="https://blog.csdn.net/xiangxianghehe/article/details/105688062">https://blog.csdn.net/xiangxianghehe/article/details/105688062</a><br>
<a href="https://mirror.tuna.tsinghua.edu.cn/help/centos/">https://mirror.tuna.tsinghua.edu.cn/help/centos/</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[在CentOS和Ubuntu上安装和配置docker]]></title>
        <id>https://tomhht.github.io/post/zai-centos-he-ubuntu-shang-an-zhuang-he-pei-zhi-docker/</id>
        <link href="https://tomhht.github.io/post/zai-centos-he-ubuntu-shang-an-zhuang-he-pei-zhi-docker/">
        </link>
        <updated>2020-09-01T10:06:21.000Z</updated>
        <summary type="html"><![CDATA[<p>整理docker安装心得。</p>
]]></summary>
        <content type="html"><![CDATA[<p>整理docker安装心得。</p>
<!-- more -->
<h1 id="centos">CentOS</h1>
<pre><code># 移除旧版
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
# 设置阿里云仓库repository
sudo yum install -y yum-utils
sudo yum-config-manager \
    --add-repo \
   http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# 安装docker
sudo yum install docker-ce docker-ce-cli containerd.io
</code></pre>
<h1 id="ubuntu">Ubuntu</h1>
<pre><code># 移除旧版
sudo apt-get remove docker docker-engine docker.io containerd runc
# 安装依赖软件
sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
# 添加Docker官方GPG KEY
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# 添加官方仓库
sudo add-apt-repository \
   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable&quot;
# 安装docker
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
</code></pre>
<p>以上操作完毕后，继续操作下面通用部分。</p>
<h1 id="通用">通用</h1>
<pre><code># 启动docker
sudo systemctl start docker
# 加入开机启动
sudo systemctl enable docker
# 允许当前用户使用docker
sudo usermod -aG docker ${USER}
# 配置国内加速器（可显著增加docker pull镜像的成功率和速度）
sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'
{
    &quot;registry-mirrors&quot;: [
        &quot;https://dockerhub.azk8s.cn/ &quot;,
        &quot;https://hub-mirror.c.163.com/&quot;,
        &quot;https://docker.mirrors.ustc.edu.cn&quot;
    ]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre>
<hr>
<p>参考链接：<br>
<a href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a><br>
<a href="https://developer.aliyun.com/article/763983">https://developer.aliyun.com/article/763983</a><br>
<a href="https://www.jianshu.com/p/5a911f20d93e">https://www.jianshu.com/p/5a911f20d93e</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Ubuntu和CentOS端口设置]]></title>
        <id>https://tomhht.github.io/post/ubuntu-he-centos-duan-kou-she-zhi/</id>
        <link href="https://tomhht.github.io/post/ubuntu-he-centos-duan-kou-she-zhi/">
        </link>
        <updated>2020-08-31T09:53:59.000Z</updated>
        <summary type="html"><![CDATA[<p>记录下端口设置，用到啥记录啥。</p>
]]></summary>
        <content type="html"><![CDATA[<p>记录下端口设置，用到啥记录啥。</p>
<!-- more -->
<h1 id="centos">CentOS</h1>
<p>核心指令<code>firewall-cmd</code></p>
<h2 id="查看已开放端口">查看已开放端口</h2>
<pre><code>sudo firewall-cmd --list-ports
</code></pre>
<h2 id="开启端口">开启端口</h2>
<pre><code>sudo firewall-cmd --zone=public --add-port=10250/tcp --permanent
sudo firewall-cmd --zone=public --add-port=30000-32767/tcp --permanent
//--zone: 作用域 
//--add-port=2181/tcp: 要开启的端口号，格式为：端口号/通讯协议 
//--permanent: 使端口永久开放，如不添加，则表示临时有效，开机重启后便会失效
//30000-32767，端口区间
</code></pre>
<h2 id="关闭端口">关闭端口</h2>
<pre><code>sudo firewall-cmd --zone=public --remove-port=6443/tcp --permanent
</code></pre>
<h2 id="reload以便-permanent配置生效">reload以便--permanent配置生效</h2>
<pre><code>sudo firewall-cmd --reload
</code></pre>
<h1 id="ubuntu">Ubuntu</h1>
<p>核心指令<code>ufw</code></p>
<h2 id="启用ufw">启用ufw</h2>
<pre><code>sudo ufw enable
sudo ufw allow ssh
</code></pre>
<h2 id="查看已开放端口-2">查看已开放端口</h2>
<pre><code>sudo ufw status
</code></pre>
<h2 id="开启端口-2">开启端口</h2>
<pre><code>sudo ufw allow 10250/tcp
sudo ufw allow 30000:32767/tcp
//30000:32767是端口区间
</code></pre>
<h2 id="关闭端口-2">关闭端口</h2>
<pre><code>sudo ufw delete allow 10250/tcp
</code></pre>
<hr>
<p>参考链接：<br>
<a href="https://www.cnblogs.com/Sungeek/p/8257681.html">https://www.cnblogs.com/Sungeek/p/8257681.html</a><br>
<a href="https://blog.csdn.net/Sun_Hui_/article/details/103178840">https://blog.csdn.net/Sun_Hui_/article/details/103178840</a><br>
<a href="https://www.itcoder.tech/posts/how-to-setup-a-firewall-with-ufw-on-ubuntu-20-04/">https://www.itcoder.tech/posts/how-to-setup-a-firewall-with-ufw-on-ubuntu-20-04/</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Ubuntu和CentOS修改grub]]></title>
        <id>https://tomhht.github.io/post/ubuntu-he-centos-xiu-gai-grub/</id>
        <link href="https://tomhht.github.io/post/ubuntu-he-centos-xiu-gai-grub/">
        </link>
        <updated>2020-08-31T03:19:33.000Z</updated>
        <summary type="html"><![CDATA[<p>grub的修改位置和生效方法。</p>
]]></summary>
        <content type="html"><![CDATA[<p>grub的修改位置和生效方法。</p>
<!-- more -->
<p>grub的修改位置是同样的。</p>
<pre><code>sudo vim /etc/default/grub
</code></pre>
<p>生效方法有区别：</p>
<pre><code>sudo grub2-mkconfig –o /etc/grub2.cfg  #CentOS
sudo update-grub2  #Ubuntu
</code></pre>
<hr>
<p>参考链接：<br>
<a href="https://blog.csdn.net/whatday/article/details/106123164">https://blog.csdn.net/whatday/article/details/106123164</a><br>
<a href="https://www.techbrown.com/change-default-grub2-entries-timeout-centos-7/">https://www.techbrown.com/change-default-grub2-entries-timeout-centos-7/</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[在Ubuntu 20.04和CentOS 8上使用kubeadm部署Kubernetes集群]]></title>
        <id>https://tomhht.github.io/post/zai-ubuntu-2004-shang-shi-yong-kubeadm-bu-shu-kubernetes-ji-qun/</id>
        <link href="https://tomhht.github.io/post/zai-ubuntu-2004-shang-shi-yong-kubeadm-bu-shu-kubernetes-ji-qun/">
        </link>
        <updated>2020-08-27T10:40:02.000Z</updated>
        <summary type="html"><![CDATA[<p>本文主要是踩坑后想记录下避坑方法，内容涉及Kubernetes, Kubeadm, Kubectl, Kubelet, Ubuntu, CentOS, Flannel, Docker, 阿里云。</p>
]]></summary>
        <content type="html"><![CDATA[<p>本文主要是踩坑后想记录下避坑方法，内容涉及Kubernetes, Kubeadm, Kubectl, Kubelet, Ubuntu, CentOS, Flannel, Docker, 阿里云。</p>
<!-- more -->
<h1 id="写作背景">写作背景</h1>
<p>初学Kubernetes，虽然网上资源很多，但没一个能彻底搞定，于是杂烩一下。</p>
<h1 id="安装前的准备工作">安装前的准备工作</h1>
<blockquote>
<p>control node（控制节点）、worker node（工作节点） 都要做这些准备工作。</p>
</blockquote>
<h2 id="检查各主机配置">检查各主机配置</h2>
<h3 id="检查cpu和内存">检查cpu和内存</h3>
<p>无论是虚拟机还是物理机，都要求<strong>cpu内核≥2，内存≥2G</strong>。</p>
<h3 id="检查主机名hostname">检查主机名hostname</h3>
<p>hostname要求<strong>不能是 localhost，且不包含下划线、小数点、大写字母</strong>。</p>
<pre><code># 检查hostname
hostname 
# 修改 hostname
hostnamectl set-hostname 名字
# 查看修改结果
hostnamectl status
# 设置 hostname 解析
echo &quot;127.0.0.1   $(hostname)&quot; &gt;&gt; /etc/hosts
</code></pre>
<h3 id="设置固定ip">设置固定IP</h3>
<p>建议使用nmcli配置，因为跨平台（Ubuntu和CentOS）。</p>
<pre><code>nmcli
//如果提示没有安装，先按下面步骤安装
# 安装nmcli
sudo yum install NetworkManager #CentOS
sudo apt-get install network-manager #Ubuntu
# 检查nmcli是否接管了网络管理
nmcli g
//正常是显示绿色的信息。如果STATE列显示disconnected，则Ubuntu要修改/etc/netplan/里的yaml文件，在version下面添加一行renderer: NetworkManager，保存退出后执行sudo systemctl daemon-reload 和 sudo systemctl restart NetworkManager
# 查看当前默认网卡和ip信息
ip route show
ip a
//ip route show 命令中，可以知道机器的网关DNS和默认网卡，如 default via 192.168.127.2 dev ens33，via后面的内容 192.168.127.2 就是网关和DNS，dev后面的内容 ens33 就是默认网卡
//ip a 命令中，可显示默认网卡的 IP 地址，Kubernetes 将使用此 IP 地址与集群内的其他节点通信，如192.168.127.131
//所有节点上 Kubernetes 所使用的 IP 地址必须可以互通（无需 NAT 映射、无安全组或防火墙隔离）
# 设置固定IP，网卡、ip地址、网关、DNS可参考上面的信息
sudo nmcli c mod ens33 \
ipv4.addresses 192.168.127.131/24 \
ipv4.method manual \
ipv4.gateway 192.168.127.2 \
ipv4.dns 192.168.127.2
# 让配置立刻生效
sudo nmcli c up ens33
</code></pre>
<h2 id="创建k8s文件夹">创建k8s文件夹</h2>
<p>存放安装过程所需文件。执行下面代码：</p>
<pre><code>mkdir ~/k8s
</code></pre>
<h2 id="设置iptables">设置iptables</h2>
<p>执行下面代码：</p>
<pre><code>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sudo sysctl --system
# 如果想检查配置，可执行
sysctl -n net.bridge.bridge-nf-call-iptables
sysctl -n net.bridge.bridge-nf-call-ip6tables
</code></pre>
<h2 id="打开端口">打开端口</h2>
<h3 id="ubuntu的准备工作centos跳过">Ubuntu的准备工作（CentOS跳过）</h3>
<p>先打开Ubuntu自带的防火墙ufw。执行下面代码：</p>
<pre><code>sudo ufw enable
</code></pre>
<p>执行后提示可能断开连接，直接y继续，别担心，ssh连接不会断。<br>
如果使用ssh连接，还需要执行下面代码，以便打开ssh连接：</p>
<pre><code>sudo ufw allow ssh
</code></pre>
<h3 id="打开相应端口">打开相应端口</h3>
<p>依据所使用的系统（Ubuntu / CentOS），执行相应代码。</p>
<ol>
<li>控制节点 Control-plane nodes</li>
</ol>
<pre><code># Ubuntu
sudo ufw allow 6443/tcp
sudo ufw allow 2379:2380/tcp
sudo ufw allow 10250:10252/tcp
//上面代码中的冒号代表端口区间。

#CentOS
sudo firewall-cmd --zone=public --add-port=6443/tcp --permanent
sudo firewall-cmd --zone=public --add-port=2379-2380/tcp --permanent
sudo firewall-cmd --zone=public --add-port=10250-10252/tcp --permanent
sudo firewall-cmd --reload
</code></pre>
<ol start="2">
<li>工作节点 Worker nodes</li>
</ol>
<pre><code># Ubuntu
sudo ufw allow 10250/tcp
sudo ufw allow 30000:32767/tcp

# CentOS
sudo firewall-cmd --zone=public --add-port=10250/tcp --permanent
sudo firewall-cmd --zone=public --add-port=30000-32767/tcp --permanent
sudo firewall-cmd --reload
</code></pre>
<h2 id="禁用swap">禁用swap</h2>
<p>由于swap性能低下，Kubeadm默认要求禁止使用swap。执行如下代码：</p>
<pre><code>sudo swapoff -a  #临时禁用swap
sudo sed -i 's/.*swap.*/#&amp;/' /etc/fstab  #永久禁用swap
</code></pre>
<p>可通过<code>free -m</code>来检查禁用效果。</p>
<h2 id="安装docker">安装docker</h2>
<p>详见<a href="/post/zai-centos-he-ubuntu-shang-an-zhuang-he-pei-zhi-docker">docker安装和配置</a></p>
<h1 id="安装kubeadm-kubelet和kubectl">安装kubeadm, kubelet和kubectl</h1>
<blockquote>
<p>control node（控制节点）、worker node（工作节点） 上都安装。</p>
</blockquote>
<p><strong>Ubuntu</strong></p>
<pre><code>sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https curl
curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -
cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main
EOF
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre>
<p><strong>CentOS</strong></p>
<pre><code>cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https:/mirrors.aliyun.com/yum/doc/yum-key.gpg https://mirrors.aliyun.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF

# Set SELinux in permissive mode (effectively disabling it)
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

sudo systemctl enable --now kubelet
</code></pre>
<h1 id="在control-node控制节点上用kubeadm创建集群">在control node控制节点上用kubeadm创建集群</h1>
<h2 id="初始化集群-方法一推荐能成功就很幸运">初始化集群 - 方法一（推荐，能成功就很幸运）</h2>
<pre><code>kubeadm init --apiserver-advertise-address=你的本机IP \
--pod-network-cidr=10.244.0.0/16 \
--kubernetes-version=v1.18.8 \
--image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers
//--image-repository指定从阿里云拉取所需镜像
#如果安装失败，再试几次，还不行就尝试方法二。
#如果安装成功，则输出类似下面内容，将内容中的`kubeadm join ...`单独保存出来，这是其他节点加入主节点的信息。跳过方法二。
...
...
kubeadm join 192.168.127.132:6443 --token 4pwz11.1m0u1k3ak3ibgx08 \
    --discovery-token-ca-cert-hash sha256:671404c4f80afe5d06d8eefcd5acc6049c4d84f1ebf1091b09bc180ea44e79b7   
</code></pre>
<p>如果安装顺利，<a href="#%E8%B5%8B%E4%BA%88%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E4%BD%BF%E7%94%A8kubectl%E7%9A%84%E6%9D%83%E9%99%90">点这里跳过方法二</a>。</p>
<h2 id="初始化集群-方法二只在方法一失败的情况下使用">初始化集群 - 方法二（只在方法一失败的情况下使用）</h2>
<p>由于种种原因，国内无法从k8s.gcr.io下载到kubeadm部署所需的文件，以下方法将通过阿里云获取。</p>
<h3 id="准备工作">准备工作</h3>
<h4 id="查看所需镜像">查看所需镜像</h4>
<pre><code>kubeadm config images list
#下面是执行的结果
k8s.gcr.io/kube-apiserver:v1.18.8
k8s.gcr.io/kube-controller-manager:v1.18.8
k8s.gcr.io/kube-scheduler:v1.18.8
k8s.gcr.io/kube-proxy:v1.18.8
k8s.gcr.io/pause:3.2
k8s.gcr.io/etcd:3.4.3-0
k8s.gcr.io/coredns:1.6.7
</code></pre>
<h4 id="在阿里云控制台找到所需镜像">在阿里云控制台找到所需镜像</h4>
<ol>
<li><a href="https://cr.console.aliyun.com/">https://cr.console.aliyun.com/</a>  左侧点”镜像搜索“</li>
<li>分别搜索”kube-apiserver“等所有名称，点开搜索到的镜像，一定找到正确的版本号（如v1.18.8）（日期越新的越容易找到），复制页面中的”公网地址“</li>
</ol>
<h4 id="pull镜像-打标签-移除无用镜像">pull镜像、打标签、移除无用镜像</h4>
<ol>
<li>pull镜像</li>
</ol>
<pre><code>KUBE_VERSION=v1.18.8
PAUSE_VERSION=3.2
ETCD_VERSION=3.4.3-0
CORE_DNS_VERSION=1.6.7
docker pull registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-apiserver:$KUBE_VERSION
docker pull registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-controller-manager:$KUBE_VERSION
docker pull registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-scheduler:$KUBE_VERSION
docker pull registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-proxy:$KUBE_VERSION
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:$PAUSE_VERSION
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:$CORE_DNS_VERSION
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:$ETCD_VERSION
</code></pre>
<ol start="2">
<li>给pull下来的镜像打标签<br>
因为kubeadm部署时会找k8s.gcr.io标签的镜像，因此需要将上一步pull的镜像打上k8s.gcr.io标签。</li>
</ol>
<pre><code>docker tag registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-apiserver:$KUBE_VERSION  k8s.gcr.io/kube-proxy:$KUBE_VERSION
docker tag registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-apiserver:$KUBE_VERSION k8s.gcr.io/kube-controller-manager:$KUBE_VERSION
docker tag registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-apiserver:$KUBE_VERSION k8s.gcr.io/kube-apiserver:$KUBE_VERSION
docker tag registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-apiserver:$KUBE_VERSION k8s.gcr.io/kube-scheduler:$KUBE_VERSION
docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:$PAUSE_VERSION k8s.gcr.io/pause:$PAUSE_VERSION
docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:$CORE_DNS_VERSION k8s.gcr.io/coredns:$CORE_DNS_VERSION
docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:$ETCD_VERSION k8s.gcr.io/etcd:$ETCD_VERSION
</code></pre>
<ol start="3">
<li>移除从阿里云pull下来的镜像</li>
</ol>
<pre><code>docker rmi registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-apiserver:$KUBE_VERSION
docker rmi registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-controller-manager:$KUBE_VERSION
docker rmi registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-scheduler:$KUBE_VERSION
docker rmi registry.cn-hangzhou.aliyuncs.com/wyc_google_containers/kube-proxy:$KUBE_VERSION
docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/pause:$PAUSE_VERSION
docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:$CORE_DNS_VERSION
docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:$ETCD_VERSION
</code></pre>
<h3 id="部署">部署</h3>
<pre><code>kubeadm init --apiserver-advertise-address=你的本机IP --pod-network-cidr=10.244.0.0/16  --kubernetes-version=v1.18.8
#执行后的输出
...
...
kubeadm join 192.168.127.132:6443 --token 4pwz11.1m0u1k3ak3ibgx08 \
    --discovery-token-ca-cert-hash sha256:671404c4f80afe5d06d8eefcd5acc6049c4d84f1ebf1091b09bc180ea44e79b7
</code></pre>
<p>将输出内容中的<code>kubeadm join ...</code>单独保存出来，这是其他节点加入主节点的信息。</p>
<h2 id="赋予当前用户使用kubectl的权限">赋予当前用户使用kubectl的权限</h2>
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<h2 id="安装网络组件flannel">安装网络组件flannel</h2>
<h3 id="准备工作-2">准备工作</h3>
<p>由于种种原因，无法直接pull到网络组件flannel的docker镜像，因此需单独下载。<br>
https://github.com/coreos/flannel/releases/download/v0.12.0/flanneld-v0.12.0-amd64.docker<br>
下载后放进<code>~/k8s</code>，执行命令：</p>
<pre><code>cd ~/k8s
docker load &lt; flanneld-v0.12.0-amd64.docker
</code></pre>
<h3 id="开始安装">开始安装</h3>
<pre><code>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
kubectl apply -f kube-flannel.yml
</code></pre>
<h2 id="检查部署情况">检查部署情况</h2>
<pre><code>kubectl get nodes
</code></pre>
<p><img src="https://tomhht.github.io/post-images/1598781753839.png" alt="节点运行情况" loading="lazy">     <br /></p>
<pre><code>kubectl get pods -A
</code></pre>
<p><img src="https://tomhht.github.io/post-images/1598781791291.png" alt="Pods运行情况" loading="lazy"><br>
通过<code>docker container ls</code>也可以看到pods里的容器运行情况。</p>
<h2 id="打开kubectl的autocompletion自动完成功能">打开kubectl的autocompletion自动完成功能</h2>
<pre><code>echo 'source &lt;(kubectl completion bash)' &gt;&gt;~/.bashrc
# 执行后，退出shell（如exit）再进入，即可实现自动完成
</code></pre>
<p>以上为control node控制节点的部署全流程。</p>
<hr>
<h1 id="worker-node工作节点加入集群">worker node工作节点加入集群</h1>
<h2 id="安装kubeadm-kubelet和kubectl-2">安装kubeadm, kubelet和kubectl</h2>
<p>在worker node上，按照上面<strong>安装前的准备工作</strong>和<strong>安装kubeadm, kubelet和kubectl</strong>操作。</p>
<h2 id="载入control-node上pull好的镜像">载入control  node上pull好的镜像</h2>
<ol>
<li>在control node上，备份出全套docker镜像（含kubeadm所需镜像+网络组件flannel镜像）：</li>
</ol>
<pre><code>cd ~/k8s
docker save k8s.gcr.io/kube-proxy:v1.18.8 \
k8s.gcr.io/kube-apiserver:v1.18.8 \
k8s.gcr.io/kube-controller-manager:v1.18.8 \
k8s.gcr.io/kube-scheduler:v1.18.8 \
k8s.gcr.io/pause:3.2 \
k8s.gcr.io/coredns:1.6.7 \
k8s.gcr.io/etcd:3.4.3-0 \
quay.io/coreos/flannel:v0.12.0-amd64 &gt; k8s-imagesV1.18.8-flannelV0.12.0.tar
</code></pre>
<blockquote>
<p>之前踩坑，偷懒用IMAGE ID做的备份，结果载入以后name和tag全都是none，还得打name和tag上去，无比繁琐- _ -||</p>
</blockquote>
<ol start="2">
<li>scp上面的备份文件到各个worker node的<code>~/k8s</code>文件夹里</li>
<li>在worker node上载入备份文件：</li>
</ol>
<pre><code>cd ~/k8s
docker load &lt; k8s-imagesV1.18.8-flannelV0.12.0.tar
</code></pre>
<blockquote>
<p>worker node实际需要的只有3个镜像，分别是<code>kube-proxy, pause, flannel</code></p>
</blockquote>
<h2 id="加入集群">加入集群</h2>
<p>执行之前在control node上单独保存出来的<code>kubeadm join...</code>，类似于：</p>
<pre><code>sudo kubeadm join 192.168.127.132:6443 --token rddtz5.mz2v4ee96177eay5     --discovery-token-ca-cert-hash sha256:671404c4f80afe5d06d8eefcd5acc6049c4d84f1ebf1091b09bc180ea44e79b7
</code></pre>
<p>如果join指令没记录下来，或者集群创建已经超过24小时了，那么需要重新生成join指令。在<strong>control node</strong>上执行：</p>
<pre><code>kubeadm token create --print-join-command
</code></pre>
<p>复制输出的内容并在<strong>worker node</strong>上执行即可加入。</p>
<hr>
<h1 id="检查部署结果">检查部署结果</h1>
<p>在control node上执行：</p>
<pre><code>kubectl get nodes -o wide
</code></pre>
<p><img src="https://tomhht.github.io/post-images/1599032788153.png" alt="集群节点信息" loading="lazy"> <br /></p>
<pre><code>kubectl get pods -A -o wide
</code></pre>
<p><img src="https://tomhht.github.io/post-images/1599032818248.png" alt="集群pods信息" loading="lazy"><br>
如果STATUS不是Running，则排查故障点：</p>
<pre><code>kubectl describe pods -n kube-system kube-proxy-t2zbw
</code></pre>
<hr>
<p>参考链接：<br>
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a><br>
<a href="https://www.cnblogs.com/hellxz/p/use-kubeadm-init-kubernetes-cluster.html">https://www.cnblogs.com/hellxz/p/use-kubeadm-init-kubernetes-cluster.html</a><br>
<a href="https://www.kuboard.cn/install/install-k8s.html">https://www.kuboard.cn/install/install-k8s.html</a><br>
<a href="https://blog.csdn.net/LeonardoYasuo/article/details/101483438">https://blog.csdn.net/LeonardoYasuo/article/details/101483438</a><br>
<a href="https://www.cnblogs.com/yinzhengjie/p/12258215.html">https://www.cnblogs.com/yinzhengjie/p/12258215.html</a><br>
<a href="https://developer.aliyun.com/article/763983">https://developer.aliyun.com/article/763983</a></p>
]]></content>
    </entry>
</feed>